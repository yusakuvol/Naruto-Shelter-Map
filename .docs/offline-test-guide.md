# オフライン動作テストガイド

**対象:** Issue #188 - MapLibre Vector Tiles対応（完全オフライン化）  
**実施日:** 2025-12-01  
**テスト環境:** 本番ビルド（`pnpm build && pnpm start`）

---

## 📋 テスト前準備

### 1. 本番ビルドの起動

```bash
# ビルド
pnpm build

# 本番サーバー起動
pnpm start
```

サーバーが起動したら、`http://localhost:3000` にアクセスします。

---

## 🧪 テスト項目

### テスト 1: Service Worker登録確認

#### 手順
1. Chrome DevToolsを開く（F12）
2. **Application**タブを選択
3. 左サイドバーで**Service Workers**をクリック

#### 確認項目
- [ ] Service Workerが登録されている
- [ ] **Status**: "activated and is running"
- [ ] **Source**: `/sw.js`
- [ ] **Scope**: `/`

#### 期待結果
✅ Service Workerが正常に登録され、アクティブになっている

---

### テスト 2: キャッシュ確認

#### 手順
1. Chrome DevTools → **Application**タブ
2. 左サイドバーで**Cache Storage**を展開
3. 各キャッシュの内容を確認

#### 確認項目
- [ ] `gsi-raster-tiles` - 国土地理院ラスタタイルキャッシュ
- [ ] `geojson-data` - 避難所データキャッシュ（`/data/shelters.geojson`）
- [ ] `static-image-assets` - 画像キャッシュ
- [ ] `pages` - ページキャッシュ
- [ ] `next-static-js-assets` - JSアセットキャッシュ

#### キャッシュサイズの確認
1. 各キャッシュをクリック
2. エントリ数を確認
3. 合計サイズを確認（Chrome DevTools → Application → Storage → Clear storage で確認可能）

#### 期待結果
✅ 必要なキャッシュがすべて存在し、適切なサイズ（合計100MB以下を目標）

---

### テスト 3: オンライン時のキャッシュ構築

#### 手順
1. ネットワークを**Online**に設定（Chrome DevTools → Network → Throttling → Online）
2. 地図を表示
3. 地図をズーム・パンして複数のタイルを読み込む
   - ズームイン/アウト（マウスホイールまたは+/-ボタン）
   - 地図をドラッグして移動
   - 鳴門市周辺の複数の範囲を表示
4. 避難所マーカーが表示されることを確認

#### 確認項目
- [ ] 地図タイルが正常に読み込まれる
- [ ] 避難所マーカーが表示される
- [ ] Network タブでタイルリクエストが確認できる
- [ ] Cache Storage にタイルが保存される

#### 期待結果
✅ オンライン時に地図タイルと避難所データがキャッシュされる

---

### テスト 4: オフライン動作テスト（最重要）

#### 手順
1. オンライン状態で地図を表示し、キャッシュを構築（テスト3を実施）
2. Chrome DevTools → **Network**タブを選択
3. **Throttling**を**Offline**に設定
4. ページをリロード（F5）

#### 確認項目
- [ ] ページが正常に表示される（オフラインでも）
- [ ] 地図が表示される（キャッシュされたタイル）
- [ ] 避難所マーカーが表示される（キャッシュされたGeoJSON）
- [ ] オフラインインジケーターが表示される（`OfflineIndicator`コンポーネント）
- [ ] 地図のズーム・パンが動作する（キャッシュされた範囲内）
- [ ] 避難所カードが表示される
- [ ] フィルタ機能が動作する

#### 期待結果
✅ オフライン環境でも、キャッシュされた範囲内で地図と避難所情報が正常に表示・操作できる

---

### テスト 5: キャッシュヒット率テスト

#### 手順
1. Chrome DevTools → **Network**タブを開く
2. オンライン状態で地図を操作（ズーム・パン）
3. Network タブでリクエストを確認
4. オフライン状態で同じ操作を繰り返す
5. Network タブでキャッシュヒット率を確認

#### 確認項目
- [ ] オンライン時のリクエスト数
- [ ] オフライン時のリクエスト数（キャッシュから読み込まれる）
- [ ] キャッシュヒット率（目標: 90%以上）

#### 期待結果
✅ オフライン時はキャッシュから読み込まれ、ネットワークリクエストが発生しない

---

### テスト 6: パフォーマンステスト

#### 手順
1. Chrome DevTools → **Network**タブを開く
2. **Disable cache**のチェックを外す（キャッシュを有効化）
3. オンライン状態で初回ロード時間を測定
4. オフライン状態でロード時間を測定

#### 確認項目
- [ ] 初回ロード時間（オンライン）: ___ 秒（目標: 5秒以内）
- [ ] オフラインロード時間: ___ 秒（目標: 3秒以内）
- [ ] Lighthouse Performance スコア（オフライン時）

#### 期待結果
✅ オフライン時のロード時間が短く、快適に使用できる

---

### テスト 7: エラーハンドリングテスト

#### 手順
1. オフライン状態で、キャッシュされていない範囲に移動
2. エラーメッセージが表示されるか確認
3. ネットワークエラーが発生してもアプリがクラッシュしないことを確認

#### 確認項目
- [ ] エラーメッセージが適切に表示される
- [ ] フォールバック動作（既存のキャッシュ範囲を表示など）
- [ ] アプリがクラッシュしない

#### 期待結果
✅ エラーが適切にハンドリングされ、ユーザーに分かりやすいメッセージが表示される

---

### テスト 8: キャッシュ更新テスト

#### 手順
1. ネットワークを**Online**に戻す
2. Chrome DevTools → **Application**タブ → **Service Workers**
3. **Update**をクリック
4. 更新通知（`UpdateNotification`）が表示されることを確認
5. **Update**ボタンをクリックして更新を適用

#### 確認項目
- [ ] Service Workerが更新される
- [ ] 更新通知が表示される
- [ ] 更新後、ページが正常に動作する
- [ ] 新しいキャッシュが構築される

#### 期待結果
✅ Service Workerの更新が正常に動作し、ユーザーに通知される

---

## 📊 テスト結果記録

テスト結果は `.docs/offline-test-results.md` に記録してください。

### 記録項目
- 各テストの結果（✅ / ❌）
- 発見された問題
- 改善提案
- キャッシュサイズ
- パフォーマンス指標

---

## 🐛 トラブルシューティング

### Service Workerが登録されない
- ブラウザのキャッシュをクリア
- `http://localhost:3000` でアクセス（`https://` ではない）
- 本番ビルド（`pnpm build && pnpm start`）を使用

### オフライン時に地図が表示されない
- オンライン時に十分な範囲のタイルをキャッシュする
- Cache Storage で `gsi-raster-tiles` にエントリがあるか確認
- Service Workerが正常に動作しているか確認

### キャッシュサイズが大きすぎる
- `next.config.js` の `maxEntries` を調整
- 不要なキャッシュをクリア

---

## ✅ 完了条件

すべてのテスト項目が ✅ になれば、オフライン動作テストは完了です。

- [ ] テスト1: Service Worker登録確認
- [ ] テスト2: キャッシュ確認
- [ ] テスト3: オンライン時のキャッシュ構築
- [ ] テスト4: オフライン動作テスト（最重要）
- [ ] テスト5: キャッシュヒット率テスト
- [ ] テスト6: パフォーマンステスト
- [ ] テスト7: エラーハンドリングテスト
- [ ] テスト8: キャッシュ更新テスト

---

## 📚 参考リンク

- [PWA テストガイド](./pwa-test-guide.md)
- [Issue #188: MapLibre Vector Tiles対応](https://github.com/yusakuvol/Naruto-Shelter-Map/issues/188)
- [Service Worker API](https://developer.mozilla.org/en-US/docs/Web/API/Service_Worker_API)

