name: Update Shelter Data

on:
  # æ¯Žé€±æœˆæ›œæ—¥ 3:00 JST (æ—¥æ›œæ—¥ 18:00 UTC)
  schedule:
    - cron: "0 18 * * 0"
  # æ‰‹å‹•å®Ÿè¡Œã‚’è¨±å¯
  workflow_dispatch:
    inputs:
      data_file:
        description: "Path to downloaded GeoJSON file (optional, for manual update)"
        required: false
        type: string

jobs:
  update-data:
    name: Update Shelter Data
    runs-on: ubuntu-latest
    permissions:
      contents: write # ã‚³ãƒŸãƒƒãƒˆãƒ»ãƒ—ãƒƒã‚·ãƒ¥ã«å¿…è¦
      pull-requests: write # PRä½œæˆã«å¿…è¦

    steps:
      - name: Checkout code
        uses: actions/checkout@v6
        with:
          # ã‚³ãƒŸãƒƒãƒˆå±¥æ­´ã‚’å–å¾—ã—ã¦ãƒ—ãƒƒã‚·ãƒ¥ã§ãã‚‹ã‚ˆã†ã«ã™ã‚‹
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup pnpm
        uses: pnpm/action-setup@v4

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: "22"
          cache: "pnpm"

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Check for manual data file
        id: check-file
        run: |
          if [ -n "${{ inputs.data_file }}" ]; then
            echo "manual_mode=true" >> $GITHUB_OUTPUT
            echo "data_file=${{ steps.check-file.outputs.data_file }}" >> $GITHUB_OUTPUT
          else
            echo "manual_mode=false" >> $GITHUB_OUTPUT
          fi

      - name: Fetch shelter data from GSI Tiles API
        id: fetch-data
        run: |
          echo "ðŸš€ åœ°ç†é™¢ã‚¿ã‚¤ãƒ«APIã‹ã‚‰é¿é›£æ‰€ãƒ‡ãƒ¼ã‚¿ã‚’è‡ªå‹•å–å¾—ã—ã¾ã™"
          if [ -n "${{ inputs.data_file }}" ]; then
            echo "mode=manual" >> $GITHUB_OUTPUT
            echo "data_file=${{ inputs.data_file }}" >> $GITHUB_OUTPUT
          else
            echo "mode=auto" >> $GITHUB_OUTPUT
            echo "data_file=auto" >> $GITHUB_OUTPUT
          fi

      - name: Process shelter data
        run: |
          if [ "${{ steps.fetch-data.outputs.mode }}" == "auto" ]; then
            echo "ðŸ“¡ åœ°ç†é™¢ã‚¿ã‚¤ãƒ«APIã‹ã‚‰è‡ªå‹•å–å¾—ä¸­..."
            pnpm tsx scripts/fetch-shelters.ts auto
          else
            echo "ðŸ“ æŒ‡å®šã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰å‡¦ç†ä¸­: ${{ steps.fetch-data.outputs.data_file }}"
            pnpm tsx scripts/fetch-shelters.ts "${{ steps.fetch-data.outputs.data_file }}"
          fi

      - name: Validate shelter data
        run: |
          echo "Validating shelter data..."
          pnpm validate:shelters || {
            echo "âŒ Data validation failed. Please check the errors above."
            echo "âš ï¸  The data will not be committed if there are errors."
            exit 1
          }
          echo "âœ… Data validation passed"

      - name: Geocode and fix coordinates
        run: |
          echo "Geocoding shelters with incorrect coordinates..."
          echo "This may take a few minutes due to rate limiting (1 request per second)..."
          pnpm geocode:shelters || {
            echo "âš ï¸  Geocoding failed or no updates needed. Continuing..."
          }
          echo "âœ… Geocoding completed"

      - name: Validate shelter data (after geocoding)
        run: |
          echo "Validating shelter data after geocoding..."
          pnpm validate:shelters || {
            echo "âŒ Data validation failed after geocoding. Please check the errors above."
            echo "âš ï¸  The data will not be committed if there are errors."
            exit 1
          }
          echo "âœ… Data validation passed after geocoding"

      - name: Check for changes
        id: git-check
        run: |
          git diff --exit-code public/data/shelters.geojson || echo "changed=true" >> $GITHUB_OUTPUT

      - name: Create or update data branch and PR
        if: steps.git-check.outputs.changed == 'true'
        id: create-branch
        run: |
          BRANCH_NAME="data/auto-update-$(date +%Y%m%d)"
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          
          # ãƒ‡ãƒ¼ã‚¿æ›´æ–°ãƒ–ãƒ©ãƒ³ãƒã‚’ä½œæˆã¾ãŸã¯ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
          git checkout -b "$BRANCH_NAME" 2>/dev/null || git checkout "$BRANCH_NAME"
          
          # å¤‰æ›´ã‚’ã‚³ãƒŸãƒƒãƒˆ
          git add public/data/shelters.geojson
          git commit -m "chore(data): Update shelter data from å›½åœŸåœ°ç†é™¢

          Updated shelter data using automated workflow.
          Source: å›½åœŸåœ°ç†é™¢ åœ°ç†é™¢ã‚¿ã‚¤ãƒ«API

          - Automatic data fetch from GSI Tiles API
          - Data processing and validation
          - Automatic coordinate correction via geocoding (if needed)

          ðŸ¤– Generated by GitHub Actions" || exit 0
          
          # ãƒ–ãƒ©ãƒ³ãƒã‚’ãƒ—ãƒƒã‚·ãƒ¥
          git push -u origin "$BRANCH_NAME" || git push
          
          echo "branch_name=$BRANCH_NAME" >> $GITHUB_OUTPUT

      - name: Create or update Pull Request
        if: steps.git-check.outputs.changed == 'true'
        uses: peter-evans/create-pull-request@v7
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          branch: ${{ steps.create-branch.outputs.branch_name }}
          base: main
          title: "chore(data): Update shelter data from å›½åœŸåœ°ç†é™¢"
          body: |
            ## ðŸ“Š é¿é›£æ‰€ãƒ‡ãƒ¼ã‚¿è‡ªå‹•æ›´æ–°

            ã“ã®PRã¯ã€åœ°ç†é™¢ã‚¿ã‚¤ãƒ«APIã‹ã‚‰è‡ªå‹•å–å¾—ã—ãŸæœ€æ–°ã®é¿é›£æ‰€ãƒ‡ãƒ¼ã‚¿ã‚’åæ˜ ã—ã¾ã™ã€‚

            ### æ›´æ–°å†…å®¹
            - ãƒ‡ãƒ¼ã‚¿ã‚½ãƒ¼ã‚¹: å›½åœŸåœ°ç†é™¢ åœ°ç†é™¢ã‚¿ã‚¤ãƒ«APIï¼ˆè‡ªå‹•å–å¾—ï¼‰
            - å‡¦ç†å†…å®¹:
              - åœ°ç†é™¢ã‚¿ã‚¤ãƒ«APIã‹ã‚‰è‡ªå‹•å–å¾—
              - ãƒ‡ãƒ¼ã‚¿å‡¦ç†ã¨æ¤œè¨¼
              - åº§æ¨™ã®è‡ªå‹•ä¿®æ­£ï¼ˆå¿…è¦ã«å¿œã˜ã¦ï¼‰

            ### è‡ªå‹•ãƒžãƒ¼ã‚¸
            ã“ã®PRã¯ã€CIãƒã‚§ãƒƒã‚¯ãŒæˆåŠŸã—ãŸã‚‰è‡ªå‹•çš„ã«ãƒžãƒ¼ã‚¸ã•ã‚Œã¾ã™ã€‚

            ðŸ¤– Generated by GitHub Actions
          labels: |
            automated
            data-update
          delete-branch: true

      - name: Create summary
        if: always()
        run: |
          echo "## ðŸ“Š Shelter Data Update Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "${{ steps.git-check.outputs.changed }}" == "true" ]; then
            echo "âœ… **Status**: Data updated successfully" >> $GITHUB_STEP_SUMMARY
            echo "ðŸ“… **Updated**: $(date +'%Y-%m-%d %H:%M:%S %Z')" >> $GITHUB_STEP_SUMMARY
            if [ "${{ steps.fetch-data.outputs.mode }}" == "auto" ]; then
              echo "ðŸ“¦ **Source**: å›½åœŸåœ°ç†é™¢ åœ°ç†é™¢ã‚¿ã‚¤ãƒ«APIï¼ˆè‡ªå‹•å–å¾—ï¼‰" >> $GITHUB_STEP_SUMMARY
            else
              echo "ðŸ“¦ **Source**: å›½åœŸåœ°ç†é™¢ é¿é›£æ‰€ãƒžãƒƒãƒ—ï¼ˆæ‰‹å‹•ãƒ•ã‚¡ã‚¤ãƒ«ï¼‰" >> $GITHUB_STEP_SUMMARY
            fi
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### Processing Steps" >> $GITHUB_STEP_SUMMARY
            echo "1. âœ… Data fetch from GSI Tiles API" >> $GITHUB_STEP_SUMMARY
            echo "2. âœ… Data processing and validation" >> $GITHUB_STEP_SUMMARY
            echo "3. âœ… Geocoding and coordinate correction" >> $GITHUB_STEP_SUMMARY
            echo "4. âœ… Final validation" >> $GITHUB_STEP_SUMMARY
          else
            echo "â„¹ï¸ **Status**: No changes detected" >> $GITHUB_STEP_SUMMARY
            echo "ðŸ“… **Checked**: $(date +'%Y-%m-%d %H:%M:%S %Z')" >> $GITHUB_STEP_SUMMARY
            if [ "${{ steps.fetch-data.outputs.mode }}" == "auto" ]; then
              echo "ðŸ“¦ **Source**: å›½åœŸåœ°ç†é™¢ åœ°ç†é™¢ã‚¿ã‚¤ãƒ«APIï¼ˆè‡ªå‹•å–å¾—ï¼‰" >> $GITHUB_STEP_SUMMARY
            fi
          fi
