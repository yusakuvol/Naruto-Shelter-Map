name: Lighthouse CI

on:
  pull_request:
    branches: [main]

jobs:
  lighthouse:
    name: Lighthouse
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Wait for Cloudflare Pages deployment
        id: wait-for-deployment
        uses: WalshyDev/cf-pages-await@v1
        with:
          accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID || '536804901952e261c3ce0ea0fb70eb0a' }}
          apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          project: 'naruto-shelter-map'
          # タイムアウト: 10分
          timeout: 600000

      - name: Run Lighthouse CI
        uses: treosh/lighthouse-ci-action@v12
        with:
          urls: |
            ${{ steps.wait-for-deployment.outputs.url }}
          uploadArtifacts: true
          temporaryPublicStorage: true
          runs: 3

      - name: Comment PR with Lighthouse results
        uses: actions/github-script@v7
        if: github.event_name == 'pull_request'
        with:
          script: |
            const fs = require('fs');
            const results = JSON.parse(fs.readFileSync('.lighthouseci/manifest.json', 'utf8'));
            const summary = results[0].summary;

            const formatScore = (score) => {
              const percentage = Math.round(score * 100);
              const emoji = percentage >= 90 ? '🟢' : percentage >= 50 ? '🟡' : '🔴';
              return `${emoji} ${percentage}`;
            };

            const comment = `## 🏠 Lighthouse CI Report

| Category | Score |
|----------|-------|
| Performance | ${formatScore(summary.performance)} |
| Accessibility | ${formatScore(summary.accessibility)} |
| Best Practices | ${formatScore(summary['best-practices'])} |
| SEO | ${formatScore(summary.seo)} |
| PWA | ${formatScore(summary.pwa)} |

**Preview URL:** ${{ steps.wait-for-deployment.outputs.url }}

---
<details>
<summary>📊 Core Web Vitals</summary>

- **LCP (Largest Contentful Paint):** Target < 2.5s
- **CLS (Cumulative Layout Shift):** Target < 0.1
- **FID (First Input Delay):** Target < 100ms

</details>
            `;

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });
